<!DOCTYPE html>
<html>
<head>
  <title>Game Container</title>
  <meta charset="utf-8">
  <script src="lib/jquery-3.2.1.min.js"></script>
  <script>
  /* global $ */
  $(document).ready(function() {
    'use strict';

    // The iframe of the game
    var iframeGame = document.getElementById('game_iframe');

    // Send a message to the child iframe
    var sendMessage = function(msg) {
        // Make sure you are sending a string, and to stringify JSON
        iframeGame.contentWindow.postMessage(msg, '*');
    };

    $(window).on('message', function(evt) {

      //Note that messages from all origins are accepted

      //=======================================================
      // Validation of message protocol
      //=======================================================
      //Get data from sent message
      var data = evt.originalEvent.data;
      
      console.log(data);

      if(data.messageType === null || data.messageType === '') {
          // Error: There is no messageType or is empty in the returned message.
          console.error("ERROR: There is no messageType or is empty in the returned message.");
      }

      switch(data.messageType) {
        case "SCORE":
            if (typeof data.score === 'undefined' || data.score === null || data.score === '') {
                // Error: There is no 'score' attribute.
                console.error("ERROR: There is no 'score' attribute.");               
            } else {
                // process data.score.
                console.log("Score received from child")
            }           
            break;
        case "SAVE":            
            if (typeof data.gameState === 'undefined' || data.gameState === null || data.gameState === '') {
                // Error: There is no 'gameState' attribute.
                console.error("ERROR: There is no 'gameState' attribute.");               
            } else {
                // process data.gameState.
                console.log("Game State received from child")
            }
            break;
        case "SETTING":
            if (typeof data.options === 'undefined' || data.options === null || data.options === '') {
                // Error: There is no 'options' attribute.
                console.error("ERROR: There is no 'options' attribute.");               
            } else {
                // process data.options.
                console.log("Settings received from child")
            }
            break;         
        case "LOAD_REQUEST":
            // process the LOAD_REQUEST
            // Sent from the game to the service, requesting that a game state (if there is one saved) is sent from the service to the game
            // The service will either respond with LOAD or  ERROR

                var savedGame2 = {
                    messageType: "LOAD",
                    gameState: {
                        playerItems: [
                            "Sword",
                            "Wizard Hat"
                        ],
                        score: 506.0 // Float
                    }
                };
                //var savedGame = null;

            // If there is a game to Load, then we respond with LOAD, otherwise we respond with ERROR.            
            if (typeof savedGame === 'undefined' || savedGame === null || savedGame === '') {
                
                var messageError = {
                    messageType: "ERROR"
                }
                sendMessage(messageError);

            } else {
                sendMessage(savedGame);
            }

            break;          
        default:
            // Error: Invalid messageType
            console.error("ERROR: Invalid messageType.");
      }

      //=======================================================
      // Processing of the message from the game
      //=======================================================
      //Create a new list item based on the data
      var newItem = '\n\t<li>' + (data.score || '') + '</li>';
      //Add the item to the beginning of the actions list
      $('#actions').prepend(newItem);
      //$('#actions').prepend(data.score);
    });
  });
  </script>
</head>

<body>
  <iframe id="game_iframe" src="game1.html" style="border:2px solid red;"></iframe>
  <ul id="actions">
  </ul>
</body>
</html>
